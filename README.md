This is a completely new patch from #13.
