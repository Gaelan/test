This is a completely new patch from #13.

Improved in #14!

jpetso changes stuff
